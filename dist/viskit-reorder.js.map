{"version":3,"file":"viskit-reorder.js","sourceRoot":"","sources":["../src/viskit-reorder.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, LitElement, property } from 'lit-element';\nimport { createGesture, Gesture } from '@ionic/core';\ntype DataCacheMap = Map<\n  HTMLElement,\n  { rect: DOMRect; itemDataMap: Map<HTMLElement, { rect: DOMRect }> }\n>;\n\nconst within = Symbol.for('within');\n\nexport class Reorder extends LitElement {\n  dataCacheMap: DataCacheMap = null;\n\n  constructor() {\n    super();\n    this.complete = this.complete.bind(this);\n    this.draggableFilter = this.draggableFilter.bind(this);\n  }\n\n  gesture: Gesture;\n\n  private selectedItemEl: HTMLElement;\n\n  @property({ attribute: false })\n  containers: HTMLElement[] = [this];\n\n  @property({ attribute: false })\n  containerSelectors: string | string[] = '';\n\n  @property({ type: Number })\n  timeout = 500;\n\n  @property({ attribute: false })\n  draggableFilter(el: HTMLElement) {\n    for (let container of this.containers) {\n      if (Array.from(container.children).find(dom => dom === el)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  @property({ type: String })\n  direction: 'x' | 'y' = 'y';\n\n  @property({ attribute: false })\n  hoverPosition(\n    x: number,\n    y: number,\n    width: number,\n    height: number,\n    currentX: number,\n    currentY: number\n  ): ['left' | 'right', 'top' | 'bottom'] {\n    return [\n      currentX <= x + width / 2 ? 'left' : 'right',\n      currentY <= y + height / 2 ? 'top' : 'bottom',\n    ];\n  }\n\n  complete(bool = false) {\n    const selectedItemEl = this.selectedItemEl;\n\n    if (selectedItemEl) {\n      if (bool) {\n        const { hoverContainer, hoverEl, hoverIndex } = this._lastHoverData;\n        hoverEl.insertAdjacentElement(\n          hoverContainer.children.item(hoverIndex) === hoverEl\n            ? 'beforebegin'\n            : 'afterend',\n          selectedItemEl\n        );\n      }\n\n      this.selectedItemEl = undefined;\n    }\n  }\n\n  [within](x, y, width, height, currentX, currentY) {\n    return (\n      x <= currentX &&\n      x + width >= currentX &&\n      y <= currentY &&\n      y + height >= currentY\n    );\n  }\n\n  async updateContainers() {\n    setTimeout(() => {\n      this.containers = [];\n      if (this.containerSelectors) {\n        for (let selector of this.containerSelectors) {\n          const containerList = this.querySelectorAll(selector);\n          this.containers = [\n            ...this.containers,\n            ...Array.from<HTMLElement>(\n              containerList as NodeListOf<HTMLElement>\n            ),\n          ];\n        }\n        this.containers = this.containers.sort((ac, bc) => {\n          const { top: btop } = bc.getBoundingClientRect();\n          const { top: atop } = ac.getBoundingClientRect();\n          return atop - btop;\n        });\n      } else {\n        this.containers = [this];\n      }\n    });\n  }\n\n  updated(map: Map<string, any>) {\n    if (map.has('containerSelectors')) {\n      this.updateContainers();\n    }\n  }\n\n  private _lastHoverData: {\n    hoverEl: HTMLElement;\n    hoverContainer: HTMLElement;\n    hoverIndex: number;\n  };\n\n  firstUpdated() {\n    let started = false,\n      ct;\n\n    const onEnd = gestureDetail => {\n      if (started) {\n        started = false;\n        clearTimeout(ct);\n        this.dispatchEvent(\n          new CustomEvent('onDrop', {\n            detail: {\n              gestureDetail,\n              complete: this.complete,\n              ...this._lastHoverData,\n            },\n          })\n        );\n      }\n    };\n    this.gesture = createGesture({\n      el: this,\n      direction: 'y',\n      gestureName: 'pzl-reorder-list',\n      disableScroll: false,\n      canStart: gestureDetail => {\n        ct = setTimeout(() => {\n          // generate DataCacheMap by containers\n          this.dataCacheMap = new Map();\n          for (let container of this.containers) {\n            const map = new Map();\n            this.dataCacheMap.set(container, {\n              rect: container.getBoundingClientRect(),\n              itemDataMap: map,\n            });\n            for (let child of Array.from(container.children)) {\n              map.set(child, { rect: child.getBoundingClientRect() });\n            }\n          }\n\n          const event = gestureDetail.event as any;\n          if (this.draggableFilter) {\n            this.selectedItemEl = event.path.find(this.draggableFilter);\n          } else {\n            let childArr = Array.from(this.children);\n            const set = new Set(childArr);\n            this.selectedItemEl = event.path.find(dom => set.has(dom));\n          }\n          if (this.selectedItemEl) {\n            started = true;\n            this.dispatchEvent(\n              new CustomEvent('onStart', {\n                detail: {\n                  el: this.selectedItemEl,\n                  gestureDetail,\n                  container: this.selectedItemEl.parentElement,\n                  reorder: this,\n                },\n              })\n            );\n          }\n        }, this.timeout);\n\n        return true;\n      },\n\n      onMove: gestureDetail => {\n        clearTimeout(ct);\n        if (started) {\n          let hoverContainer: HTMLElement;\n          let hoverEl: HTMLElement;\n          let hoverIndex: number;\n\n          for (let [container, metadata] of this.dataCacheMap) {\n            const { x, y, width, height } = metadata.rect;\n            if (\n              this[within](\n                x,\n                y,\n                width,\n                height,\n                gestureDetail.currentX,\n                gestureDetail.currentY\n              )\n            ) {\n              hoverContainer = container;\n              const childs = Array.from(container.children);\n              for (let i = 0, len = childs.length; i < len; i++) {\n                const child = childs[i];\n                const data = metadata.itemDataMap.get(child as HTMLElement);\n                if (data) {\n                  const {\n                    rect: { x, y, width, height },\n                  } = data;\n                  if (\n                    this[within](\n                      x,\n                      y,\n                      width,\n                      height,\n                      gestureDetail.currentX,\n                      gestureDetail.currentY\n                    )\n                  ) {\n                    hoverEl = child as HTMLElement;\n                    if(hoverEl === this.selectedItemEl){\n                      container;\n                    }\n                    const [hp, vp] = this.hoverPosition(\n                      x,\n                      y,\n                      width,\n                      height,\n                      gestureDetail.currentX,\n                      gestureDetail.currentY\n                    );\n\n                    if (this.direction === 'y') {\n                      vp === 'top' ? (hoverIndex = i) : (hoverIndex = i + 1);\n                    } else {\n                      hp === 'left' ? (hoverIndex = i) : (hoverIndex = i + 1);\n                    }\n\n                    break;\n                  }\n                }\n              }\n              break;\n\n            }\n          }\n\n          this._lastHoverData = {\n            hoverEl,\n            hoverContainer,\n            hoverIndex,\n          };\n\n          this.dispatchEvent(\n            new CustomEvent('onDrag', {\n              detail: {\n                el: this.selectedItemEl,\n                gestureDetail,\n                container: this.selectedItemEl.parentElement, // TODO\n                reorder: this,\n                hoverEl,\n                hoverContainer,\n                hoverIndex,\n              },\n            })\n          );\n        }\n      },\n      onEnd,\n      notCaptured: ev => {\n        if (started) {\n          return onEnd(ev);\n        }\n      },\n    });\n\n    this.gesture.enable(true);\n  }\n\n  render() {\n    return html`<slot></slot>`;\n  }\n}\n\nwindow.customElements.define('viskit-reorder', Reorder);\n"]}